# Loneliness

実行時間制限：2 sec

## 問題文

数直線上に $1, 2, ..., 60$ の番号が付けられた人がいます。\
$i$ の番号が付けられた人を人 $i$ と呼びます。\
番号が同じ人は 2 人で 1 つのペアを組むことができます。<br>

$Q$ 個のクエリが与えられるので順に処理してください。各クエリは次の
2 種類のどちらかです。

- `1 L R l r`：区間 $\lbrack L, R \rparen$ 内に人 $l, l+1, ... , r$ がそれぞれ奇数人、それ以外の人は偶数人いるという情報が与えられる。
- `2 L R`：区間 $\lbrack L, R \rparen$ にいる人で可能な限りペアを組んだ場合に、ペアになれずに残る人数を出力する。質問の時点で答えが一通りに定まらない場合は、代わりに `Ambiguous` と出力する。

なお、各人は複数の区間にまたがることはないものとします。

## 制約

- $1 \leq Q \leq 2 \times 10^5$
- $1 \leq L < R \leq 10^9$
- $1 \leq l \leq r \leq 60$
- 入力は全て整数である。
- 矛盾するような入力は与えられない。
- `2 L R` のクエリは少なくとも 1 回以上与えられる。

## 部分点

この問題はいくつかの小課題に分けられ、その小課題の全てのテストケースに正解した場合に、「この小課題に正解した」とみなされます。
提出したソースコードの得点は、正解した小課題の点数の合計となります。

1. （20 点） $Q \leq 3000$ を満たす。
2. （80 点） 追加の制約はない。

## 入力

入力は以下の形式で与えられます。

```txt
Q
Query_1
Query_2
:
Query_Q
```

## 出力

`2 L R` のクエリに対する答えを、1 行に 1 つずつ、順に出力せよ。

### 入力例 1

```txt
7
1 1 3 2 2
2 1 3
1 1 2 1 1
2 1 4
2 2 3
1 2 4 1 2
2 3 4
```

### 出力例 1

```txt
1
Ambiguous
2
0
```

1 つ目のクエリでは、区間 $\lbrack 1, 3 \rparen$ には人 2 が奇数人、それ以外の人 1, 3 が偶数人いるという情報が得られます。<br>
3 つ目のクエリでは、区間 $\lbrack 1, 2 \rparen$ には人 1 が奇数人、それ以外の人 2, 3 が偶数人存在するという情報が得られます。<br>
5 つ目のクエリでは、区間 $\lbrack 2, 3 \rparen$ に人 1, 2, 3 はそれぞれ奇数, 奇数, 偶数人存在することが分かるので、ペアになれずに残る人は 2 人です。

なお、この入力例は小課題 1, 2 の制約を満たします。

### 入力例 2

```txt
9
2 1 2
1 1 3 1 60
1 1 2 1 30
1 2 3 31 60
1 2 3 31 60
2 1 2
2 1 2
2 1 3
2 2 3

```

### 出力例 2

```txt
Ambiguous
30
30
60
30
```

1 つ目のクエリでは、区間 $\lbrack 1, 2 \rparen$ の人に関する情報がなく、答えが一通りに定まらないため `Ambiguous` と出力します。<br>
同じクエリが何度も出現する場合もあるので注意してください。<br>
なお、この入力例は小課題 1, 2 の制約を満たします。

## 解法

- `sol-cpp-partial1`: C++ 部分点 1
- `sol-py-partial1`: Python 部分点 1
- `sol-cpp-ac`: C++ AC
- `sol-py-ac`: Python AC

### 部分点 1 解法

まず、今回はクエリで現れる区間の長さは特に考慮しないため、クエリを先読みして座標圧縮をしても問題ありません。
また、クエリの数が $Q$ 個という情報より、地点として現れる座標の数は $2Q$ 個以下であることが保証されます。

ここで二つの区間 $\lbrack L_1, R_1 \rparen, \lbrack L_2, R_2 \rparen$ を考えます。（$L_1 < L_2 < R_1 < R_2$ とする。）<br>
また、$\lbrack L_1, R_1 \rparen$ には人 $l_1, l_1 + 1, ... , r_1$ が、$\lbrack L_2, R_2 \rparen$ には人 $l_2, l_2 + 1, ... , r_2$ が奇数人いるとし、それ以外に偶数人いるとします。

すると、二つの区間が重なった区間 $\lbrack L_2, R_1 \rparen$ は、奇数 + 奇数 = 偶数人存在することが分かります。<br>
これは和の mod 2 の演算をしていることに等しいため、XOR 演算を用いて区間の情報を管理することができます。

よって、クエリ 1 では L, R にコスト $\sum_{i=1}^{60} 2^{i-1}\times$ (人 $i$ の人数 $\% 2$) の辺を張り、クエリ 2 では移動時に XOR を行うようにして L から R へ BFS を行うことで、 $O(Q^2)$ で解くことができます。

### 満点解法

満点解法に用いる事実として、以下があります。<br>
以下では、$\lbrack L, R \rparen$ におけるコストを $C_{L,R}$ とし、 $C_{L,R} = \sum_{i=1}^{60} 2^{i-1}\times$ (人 $i$ の人数 $\% 2$) とします。

- $P_1 < P_2 < P_3$ として、 $C_{P_1,P_3} = C_{P_1,P_2} \oplus C_{P_2,P_3}$
  - XOR より $C_{P_1,P_2} = C_{P_1,P_3} \oplus C_{P_2,P_3}, C_{P_2,P_3} = C_{P_1,P_2} \oplus C_{P_1,P_3}$ も成り立つ。

クエリ 1 で与えられる情報の端点を移動して $L$ から $R$ にたどり着けるとき、経路に依らず $C_{L,R}$ が一意に定まることがわかります。<br>
よって、これはポテンシャルの概念と同じくとらえることができ、重み付き UnionFind を使って $O(Q)$ で解くことができます。
